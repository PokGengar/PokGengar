### 网络不通问题排查
网络架构是非常常见的二层网络，组网介绍：
![image](https://github.com/user-attachments/assets/6ef09f12-9074-4bf3-a44a-e5a1f84588d4)

终端 -- 核心交换机 -- （LAN）SDWAN（WAN） -- 核心交换机 -- 防火墙 -- ISP

- 终端连接无线网络入网；
- 无线网络网关部署在 SDWAN；
- SDWAN 端口有 WAN 和 LAN，流量从 LAN ——》 WAN 会默认做 SNAT；
- 核心交换机为 SDWAN 端口 WAN 分配 IP，为 SDWAN 端口 LAN 透传无线网络 VLAN；
- 防火墙部署 trust ——》 untrust 的 SNAT。

SDWAN 是本次网络实施中改造的部分，完成部署后发现 SDWAN 无法通过端口 WAN 上网，检查核心交换机、SDWAN、防火墙的出局路由和回程路由，均未发现问题。期间还因为忽略了 SDWAN 默认的 SNAT 功能，导致回程路由的目的地址配置成了无线网络的网段，应该配置成端口 WAN 的网段，且回程路由只需要在防火墙进行配置既可，核心交换机上有直连路由，不需要二次配置静态路由。

排查路由无果，想到整段路径中涉及到了 2 次 SNAT，于是用数据包中 S-IP 和 D-IP 的方式来梳理。

**出局路径**

终端
| S-IP  | D-IP |
| ------------- | ------------- |
| User-IP  | 0.0.0.0  |

SDWAN
| S-IP  | D-IP |
| ------------- | ------------- |
| User-IP  | 0.0.0.0  |

核心交换机
| S-IP  | D-IP |
| ------------- | ------------- |
| SDWAN WAN-IP  | 0.0.0.0  |

防火墙
| S-IP  | D-IP |
| ------------- | ------------- |
| ISP-IP  | 0.0.0.0  |

**回程路径**

防火墙
| S-IP  | D-IP |
| ------------- | ------------- |
| 0.0.0.0  | ISP-IP  |

核心交换机
| S-IP  | D-IP |
| ------------- | ------------- |
| 0.0.0.0  | SDWAN WAN-IP  |

SDWAN
| S-IP  | D-IP |
| ------------- | ------------- |
| 0.0.0.0  | User-IP  |

终端
| S-IP  | D-IP |
| ------------- | ------------- |
| 0.0.0.0  | User-IP  |

SDWAN 的 SNAT 是基于端口默认配置，入端口是 LAN，出接口是 WAN，会默认做 SNAT。

防火墙的 SNAT 是基于地址池，入区域是 trust 且网段匹配 x.x.x.x/x，出区域是 untrust，会执行 SNAT，问题就出现在这里，由于此次 SDWAN 是改造新增加的设备，端口 WAN 的地址是新增且未在防火墙配置相应的地址组，所以 SDWAN 不具备访问公网的可能，所以无法上网。
